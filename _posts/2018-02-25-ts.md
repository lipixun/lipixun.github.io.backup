---
layout: post
title: "论文快读 - An Empirical Evaluation of Thompson Sampling"
category: 论文快读
description: "EE方法"
date: 2018-02-25
tags: [paper,recommendation]
comments: true
mathjax: true
---

[原文请狂击这里](https://papers.nips.cc/paper/4321-an-empirical-evaluation-of-thompson-sampling.pdf)

## 概述

汤普森抽样（以下简称TS）是EE方法的一种，所以提到TS不得不介绍一下EE。

EE全称Explore & Exploit，假设在一个广告系统中尝试选择一个最佳的广告展现给用户，那么Explore指选择一个之前没有被（或者很少被）展现的广告来观察用户是否喜欢、而Exploit指在已经被大量用户验证过的广告中选择一个最好的展现给用户。

所以可以看到Exploit是一个近似于贪心算法的方法，这个方法可以得到一个局部的最优解但是很可能会失去全局最优解因为最优的结果可能还没有被用户访问到；Explore则一直尝试新的解以便于找到最佳的答案，但是很可能会浪费大量的机会用于展示不良的解。所以很明显单纯的Exploit或者Explore都不是一个合理的方法，一个合理的方法应当是综合考虑了Explore & Exploit在成本与收益中取得一个最佳的trade off，解决这类问题的方法被称之为**EE**方法。

TS就是一种非常有效的EE方法，而且神奇的是这个方法的原理非常的简单。同时考虑到现实问题中大量的情况都可以近似看作为相互独立的事件，所以实现起来更加的容易。

## 方法

TS用贝叶斯估计去解释比较容易理解：首先假设变量$c \in Context$表示上下文信息、$a \in Action$表示需要预估的动作、$r$表示执行一个动作之后得到的reward（譬如CTR预估中，可以将reward建模为是否点击）、$\theta$表示概率分布参数，那么观测数据$D = \{(c, a, r)\}$。那么最佳的动作动作服从分布：

$$Action = \max_{a'} E(r|a', x, \theta)P(\theta|D)$$

那么接下来的问题就是如何估计$P(\theta|D)$，根据贝叶斯公式：

$$P(\theta|D) \thicksim P(D|\theta)P(\theta)$$

其中$P(\theta)$是$\theta$的先验分布，$P(D\|\theta)$是观测到的结果。如果$P(\theta)$与$P(D\|\theta)$满足共轭分布的约束，那么迭代训练过程就可以简化为根据每次增量的数据计算$P(\theta\|D)$得到分布可以作为下一次输入的$P(\theta)$。

那么在现实的问题中，大部分情况下$P(D\|\theta)$都满足**二项分布**（也就是N次独立伯努利试验），这在常见的推荐、广告等算法中都是成立的。那么自然的就可以选择**Beta分布**作为$\theta$的概率分布。

那么我们可以带入一个实际的场景中：

假设$\alpha, \beta$是**Beta分布**的先验参数分别表示正样本和负样本的先验估计数量，计数器$Pos$表示正样本数量、$Neg$表示负样本数量（注意：$\alpha$ $\beta$ 和计数器不一定需要是样本数量，这里这样写仅仅是为了易于理解），共有$K$个动作可以选择，那么迭代算法：

```python
for t = 1...T
	for i = 1..K
		从Beta(Pos(i) + alpha(i), Neg(i) + beta(i))分布中抽样一个参数theta(i)
	- 将所有theta排序后选择最大的一个，对应的i就是选择的动作
	- 观察选择i之后的反馈结果
	if r == 1
		Pos(i) ++
	else
		Neg(i) ++
```

以上算法用代码实现起来非常简单一行代码即可，但是其实验效果确非常的好，不得不说这是一个数学上的胜利。至于为何更新Beta分布参数那一步如此之简单需要简单计算一下Beta分布和二项分布的公式，网上资料很多这里就不赘述了。如果实际情况中不满足二项分布那么也可以使用TS算法，只不过在迭代更新参数的时候要麻烦一些，有时候可能还需要一些近似的方法。

## 扩展

### 广告应用

原文中提到的一个方法，更新参数那块没有看的特别懂。原理上和之前一样，只是其假设了参数$w$满足正态分布，然后用拉布拉斯近似去更新参数，这里面应该有很多数学上的道道暂时先列在TODO里吧。

原文是用LogisticRegression作为例子的，我想知道如果把TS抽样推广到任意网络或者说一个NN网络上是一个什么样的形式？

### 计算先验

在上述的伪代码描述的算法中另外一个简化就是$c$被扔掉了，这是有意为之简化问题的。那么如果要带上$c$原文没有提到对应的方法不过我个人感觉可以用$c$来估计先验概率参数$\alpha, \beta$。
